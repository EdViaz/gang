<!DOCTYPE html>
<html lang="it">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Pianificatore Orario Universit√† e Lavoro</title>
    <style>
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        margin: 0;
        padding: 20px;
        background-color: #f0f2f5;
      }
      .container {
        max-width: 1600px;
        margin: 0 auto;
        background-color: white;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        overflow: hidden;
      }
      .header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 25px;
        text-align: center;
      }
      h1 {
        margin: 0;
        font-size: 28px;
        font-weight: 600;
      }
      .controls {
        background-color: #f8f9fa;
        padding: 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 15px;
        border-bottom: 1px solid #e0e0e0;
      }
      .week-selector {
        display: flex;
        align-items: center;
        gap: 10px;
      }
      button {
        background-color: #667eea;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        transition: all 0.3s ease;
      }
      button:hover {
        background-color: #5a67d8;
        transform: translateY(-1px);
      }
      .week-display {
        font-size: 16px;
        font-weight: 600;
        color: #333;
        padding: 10px 20px;
        background-color: white;
        border-radius: 6px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      }
      .legend {
        display: flex;
        gap: 20px;
        align-items: center;
      }
      .legend-item {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 14px;
      }
      .legend-box {
        width: 24px;
        height: 24px;
        border-radius: 4px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      .schedule-container {
        padding: 20px;
        overflow-x: auto;
      }
      .schedule-grid {
        display: grid;
        grid-template-columns: 80px repeat(4, 1fr);
        gap: 1px;
        background-color: #e0e0e0;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        overflow: hidden;
        min-width: 1000px;
      }
      .time-slot {
        background-color: #f8f9fa;
        padding: 10px;
        text-align: center;
        font-weight: 600;
        color: #555;
        font-size: 14px;
      }
      .day-header {
        background-color: #4a5568;
        color: white;
        padding: 15px;
        text-align: center;
        font-weight: 600;
        font-size: 16px;
      }
      .time-header {
        background-color: #4a5568;
        color: white;
        padding: 15px;
        text-align: center;
        font-weight: 600;
      }
      .slot {
        background-color: white;
        min-height: 60px;
        position: relative;
        cursor: pointer;
        transition: background-color 0.2s ease;
      }
      .slot:hover {
        background-color: #f0f0f0;
      }
      .event {
        position: absolute;
        left: 2px;
        right: 2px;
        padding: 8px;
        border-radius: 6px;
        font-size: 13px;
        color: white;
        cursor: move;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        transition: all 0.2s ease;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }
      .event:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
      }
      .event-uni {
        background-color: #3498db;
      }
      .event-work1 {
        background-color: #e74c3c;
      }
      .event-work2 {
        background-color: #f39c12;
      }
      .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        animation: fadeIn 0.3s ease;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }
      .modal-content {
        background-color: white;
        margin: 10% auto;
        padding: 30px;
        border-radius: 12px;
        width: 90%;
        max-width: 500px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        animation: slideIn 0.3s ease;
      }
      @keyframes slideIn {
        from {
          transform: translateY(-50px);
          opacity: 0;
        }
        to {
          transform: translateY(0);
          opacity: 1;
        }
      }
      .form-group {
        margin-bottom: 20px;
      }
      label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: #333;
      }
      input,
      select,
      textarea {
        width: 100%;
        padding: 10px;
        border: 2px solid #e0e0e0;
        border-radius: 6px;
        font-size: 14px;
        transition: border-color 0.3s ease;
      }
      input:focus,
      select:focus,
      textarea:focus {
        outline: none;
        border-color: #667eea;
      }
      .button-group {
        display: flex;
        gap: 10px;
        margin-top: 25px;
      }
      .btn-save {
        background-color: #27ae60;
      }
      .btn-save:hover {
        background-color: #219a52;
      }
      .btn-cancel {
        background-color: #95a5a6;
      }
      .btn-cancel:hover {
        background-color: #7f8c8d;
      }
      .btn-delete {
        background-color: #e74c3c;
      }
      .btn-delete:hover {
        background-color: #c0392b;
      }
      .stats-container {
        padding: 20px;
        background-color: #f8f9fa;
        border-top: 1px solid #e0e0e0;
      }
      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
      }
      .stat-card {
        background-color: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        text-align: center;
      }
      .stat-value {
        font-size: 28px;
        font-weight: 700;
        color: #667eea;
      }
      .stat-label {
        font-size: 14px;
        color: #666;
        margin-top: 5px;
      }
      .close {
        float: right;
        font-size: 28px;
        font-weight: bold;
        color: #aaa;
        cursor: pointer;
      }
      .close:hover {
        color: #333;
      }
      .export-section {
        padding: 20px;
        background-color: #e8f4f8;
        margin: 20px;
        border-radius: 8px;
      }
      .conflict-warning {
        background-color: #ff6b6b;
        color: white;
        padding: 10px;
        border-radius: 6px;
        margin-top: 10px;
        font-size: 14px;
        display: none;
      }
      .form-actions {
        display: flex;
        gap: 10px;
        margin-top: 20px;
        justify-content: flex-end;
      }
      .form-actions button {
        padding: 10px 15px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        transition: background-color 0.3s ease;
      }
      .form-actions button[type="submit"] {
        background-color: #27ae60;
        color: white;
      }
      .form-actions button[type="submit"]:hover {
        background-color: #219a52;
      }
      .form-actions button[type="button"] {
        background-color: #95a5a6;
        color: white;
      }
      .form-actions button[type="button"]:hover {
        background-color: #7f8c8d;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>üìö Pianificatore Orario Universit√† e Lavoro</h1>
      </div>

      <div class="controls">
        <div class="week-selector">
          <button onclick="previousWeek()">‚Üê Settimana precedente</button>
          <div class="week-display" id="weekDisplay">
            Settimana del 25 Nov - 1 Dic 2024
          </div>
          <button onclick="nextWeek()">Settimana successiva ‚Üí</button>
        </div>
        <div class="legend">
          <div class="legend-item">
            <div class="legend-box" style="background-color: #3498db"></div>
            <span>Universit√†</span>
          </div>
          <div class="legend-item">
            <div class="legend-box" style="background-color: #e74c3c"></div>
            <span>Lavoro P1</span>
          </div>
          <div class="legend-item">
            <div class="legend-box" style="background-color: #f39c12"></div>
            <span>Lavoro P2</span>
          </div>
        </div>
      </div>

      <div class="schedule-container">
        <div class="schedule-grid" id="scheduleGrid">
          <!-- Grid will be generated by JavaScript -->
        </div>
      </div>

      <div class="stats-container">
        <h3 style="margin-bottom: 20px; color: #333">Riepilogo Settimanale</h3>
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-value" id="uniHours">0</div>
            <div class="stat-label">Ore di Universit√†</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="work1Hours">0</div>
            <div class="stat-label">Ore Lavoro Persona 1</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="work2Hours">0</div>
            <div class="stat-label">Ore Lavoro Persona 2</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="conflicts">0</div>
            <div class="stat-label">Conflitti Orari</div>
          </div>
        </div>
      </div>

      <div class="export-section">
        <h3>Gestione Dati</h3>
        <p>I tuoi dati vengono salvati automaticamente online e localmente</p>
        <div id="authSection" style="margin-bottom: 20px">
          <input
            type="email"
            id="userEmail"
            placeholder="La tua email"
            style="width: 250px; margin-right: 10px"
          />
          <button onclick="signUp()" id="signUpBtn">üîê Registrati</button>
          <button onclick="signIn()" id="signInBtn">üîë Accedi</button>
          <button onclick="signOut()" id="signOutBtn" style="display: none">
            üö™ Esci
          </button>
        </div>
        <div
          id="userInfo"
          style="display: none; margin-bottom: 15px; color: #27ae60"
        >
          üë§ Connesso come: <span id="userEmailDisplay"></span>
        </div>
        <button onclick="exportToCSV()">üìä Esporta in CSV</button>
        <button onclick="saveToLocal()">üíæ Salva Locale</button>
        <button onclick="loadFromLocal()">üìÇ Carica Dati Salvati</button>
        <button onclick="syncData()" id="syncBtn" style="display: none">
          üîÑ Sincronizza Online
        </button>
      </div>
    </div>

    <!-- Modal for adding/editing events -->
    <div id="eventModal" class="modal">
      <div class="modal-content">
        <span class="close" onclick="closeModal()">&times;</span>
        <h2 id="modalTitle">Aggiungi Evento</h2>
        <form id="eventForm">
          <div class="form-group">
            <label for="eventType">Tipo di evento:</label>
            <select id="eventType" required>
              <option value="uni">üéì Universit√†</option>
              <option value="work1">üíº Lavoro Persona 1</option>
              <option value="work2">üíº Lavoro Persona 2</option>
            </select>
          </div>
          <div class="form-group">
            <label for="eventTitle">Titolo:</label>
            <input type="text" id="eventTitle" required>
          </div>
          <div class="form-group">
            <label for="eventLocation">Luogo (opzionale):</label>
            <input type="text" id="eventLocation">
          </div>
          <div class="form-group">
            <label for="eventNotes">Note (opzionale):</label>
            <textarea id="eventNotes" rows="3"></textarea>
          </div>
          <div class="conflict-warning" id="conflictWarning">
            ‚ö†Ô∏è Attenzione: Questo evento √® in conflitto con altri eventi esistenti!
          </div>
          <div class="form-actions">
            <button type="submit">üíæ Salva</button>
            <button type="button" onclick="closeModal()">‚ùå Annulla</button>
            <button type="button" id="deleteBtn" onclick="deleteEvent()" style="display: none; background-color: #e74c3c;">üóëÔ∏è Elimina</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Script Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
      // Inizializzazione Supabase
      async function initSupabase() {
        try {
          if (SUPABASE_URL !== "https://your-project.supabase.co") {
            const { createClient } = supabase;
            supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

            // Controlla se l'utente √® gi√† autenticato
            const {
              data: { user },
            } = await supabaseClient.auth.getUser();
            if (user) {
              currentUser = user;
              updateAuthUI(true);
              loadFromSupabase();
            }
          }
        } catch (error) {
          console.log("Supabase non configurato, usando solo storage locale");
        }
      }

      async function signUp() {
        const email = document.getElementById("userEmail").value;
        if (!email || !supabaseClient) return;

        try {
          const { data, error } = await supabaseClient.auth.signUp({
            email: email,
            password:
              "temp-password-" + Math.random().toString(36).substring(7),
          });

          if (error) throw error;
          alert("Controlla la tua email per il link di conferma!");
        } catch (error) {
          alert("Errore registrazione: " + error.message);
        }
      }

      async function signIn() {
        const email = document.getElementById("userEmail").value;
        if (!email || !supabaseClient) return;

        try {
          const { data, error } = await supabaseClient.auth.signInWithOtp({
            email: email,
          });

          if (error) throw error;
          alert("Controlla la tua email per il link di accesso!");
        } catch (error) {
          alert("Errore accesso: " + error.message);
        }
      }

      async function signOut() {
        if (!supabaseClient) return;

        await supabaseClient.auth.signOut();
        currentUser = null;
        updateAuthUI(false);
      }

      function updateAuthUI(isLoggedIn) {
        document.getElementById("signUpBtn").style.display = isLoggedIn
          ? "none"
          : "inline-block";
        document.getElementById("signInBtn").style.display = isLoggedIn
          ? "none"
          : "inline-block";
        document.getElementById("signOutBtn").style.display = isLoggedIn
          ? "inline-block"
          : "none";
        document.getElementById("syncBtn").style.display = isLoggedIn
          ? "inline-block"
          : "none";
        document.getElementById("userInfo").style.display = isLoggedIn
          ? "block"
          : "none";

        if (isLoggedIn && currentUser) {
          document.getElementById("userEmailDisplay").textContent =
            currentUser.email;
        }
      }

      async function saveToSupabase() {
        if (!supabaseClient || !currentUser) return;

        const weekKey = `week_${currentWeekStart.toISOString().split("T")[0]}`;
        const weekData = {};

        document.querySelectorAll(".slot").forEach((slot) => {
          const key = `${slot.dataset.day}_${slot.dataset.time}`;
          const events = [];

          slot.querySelectorAll(".event").forEach((event) => {
            const type = event.classList.contains("event-uni")
              ? "uni"
              : event.classList.contains("event-work1")
              ? "work1"
              : "work2";
            const title = event.querySelector("strong").textContent;
            const locationEl = event.querySelector("small");

            events.push({
              type,
              title,
              location: locationEl ? locationEl.textContent : "",
            });
          });

          if (events.length > 0) {
            weekData[key] = events;
          }
        });

        try {
          const { error } = await supabaseClient.from("schedules").upsert({
            user_id: currentUser.id,
            week_key: weekKey,
            data: weekData,
            updated_at: new Date().toISOString(),
          });

          if (error) throw error;
        } catch (error) {
          console.error("Errore salvataggio online:", error);
        }
      }

      async function loadFromSupabase() {
        if (!supabaseClient || !currentUser) return;

        const weekKey = `week_${currentWeekStart.toISOString().split("T")[0]}`;

        try {
          const { data, error } = await supabaseClient
            .from("schedules")
            .select("data")
            .eq("user_id", currentUser.id)
            .eq("week_key", weekKey)
            .single();

          if (error && error.code !== "PGRST116") throw error;

          if (data && data.data) {
            // Pulisci gli eventi esistenti
            document
              .querySelectorAll(".event")
              .forEach((event) => event.remove());

            Object.entries(data.data).forEach(([key, events]) => {
              const [day, time] = key.split("_");
              const slot = document.querySelector(
                `[data-day="${day}"][data-time="${time}"]`
              );

              if (slot) {
                events.forEach((eventData) => {
                  const event = createEvent(eventData);
                  slot.appendChild(event);
                });
              }
            });

            updateStats();
          }
        } catch (error) {
          console.error("Errore caricamento online:", error);
        }
      }

      async function syncData() {
        await saveToSupabase();
        await loadFromSupabase();
        alert("Dati sincronizzati con successo!");
      }

      // Listener per cambio autenticazione
      if (typeof supabase !== "undefined") {
        supabase
          .createClient("", "")
          .auth.onAuthStateChange((event, session) => {
            if (event === "SIGNED_IN") {
              currentUser = session.user;
              updateAuthUI(true);
              loadFromSupabase();
            } else if (event === "SIGNED_OUT") {
              currentUser = null;
              updateAuthUI(false);
            }
          });
      }

      // Configurazione Supabase (sostituisci con le tue credenziali)
      // Configurazione Supabase (sostituisci con le tue credenziali)
      const SUPABASE_URL = "https://sfpoczkspfgecqexsjlk.supabase.co";
      const SUPABASE_ANON_KEY =
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNmcG9jemtzcGZnZWNxZXhzamxrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkxODIzMzMsImV4cCI6MjA3NDc1ODMzM30.AuI9HT9KwL4nDfUWT6aw3Q0nB9iwGMFLVunz9X7WAQw";

      let supabaseClient = null;
      let currentUser = null;

      let currentWeekStart = new Date();
      currentWeekStart.setDate(
        currentWeekStart.getDate() - currentWeekStart.getDay() + 1
      );

      let events = {};
      let currentEditingEvent = null;
      let currentSlot = null;

      const timeSlots = [
        "08:00",
        "09:00",
        "10:00",
        "11:00",
        "12:00",
        "13:00",
        "14:00",
        "15:00",
        "16:00",
        "17:00",
        "18:00",
        "19:00",
        "20:00",
        "21:00",
      ];

      const days = ["Luned√¨", "Marted√¨", "Mercoled√¨", "Gioved√¨"];

      function initializeSchedule() {
        const grid = document.getElementById("scheduleGrid");
        grid.innerHTML = "";

        // Add header row
        grid.appendChild(createCell("time-header", "Orario"));
        days.forEach((day) => {
          grid.appendChild(createCell("day-header", day));
        });

        // Add time slots
        timeSlots.forEach((time, timeIndex) => {
          grid.appendChild(createCell("time-slot", time));

          days.forEach((day, dayIndex) => {
            const slot = createCell("slot", "");
            slot.dataset.time = time;
            slot.dataset.day = dayIndex;
            slot.dataset.timeIndex = timeIndex;
            slot.onclick = function () {
              openModal(this);
            };
            grid.appendChild(slot);
          });
        });

        updateWeekDisplay();
        loadEvents();
      }

      function createCell(className, content) {
        const cell = document.createElement("div");
        cell.className = className;
        cell.textContent = content;
        return cell;
      }

      function openModal(slot) {
        currentSlot = slot;
        currentEditingEvent = null;
        document.getElementById("modalTitle").textContent = "Aggiungi Evento";
        document.getElementById("eventForm").reset();
        document.getElementById("deleteBtn").style.display = "none";
        document.getElementById("conflictWarning").style.display = "none";
        document.getElementById("eventModal").style.display = "block";
      }

      function closeModal() {
        document.getElementById("eventModal").style.display = "none";
        currentSlot = null;
        currentEditingEvent = null;
      }

      function createEvent(data) {
        const event = document.createElement("div");
        event.className = `event event-${data.type}`;
        event.innerHTML = `
                <strong>${data.title}</strong>
                ${data.location ? `<br><small>${data.location}</small>` : ""}
            `;
        event.onclick = function (e) {
          e.stopPropagation();
          editEvent(data, event);
        };
        return event;
      }

      function editEvent(data, eventElement) {
        currentEditingEvent = { data, element: eventElement };
        document.getElementById("modalTitle").textContent = "Modifica Evento";
        document.getElementById("eventType").value = data.type;
        document.getElementById("eventTitle").value = data.title;
        document.getElementById("eventLocation").value = data.location || "";
        document.getElementById("eventNotes").value = data.notes || "";
        document.getElementById("deleteBtn").style.display = "block";
        document.getElementById("eventModal").style.display = "block";
      }

      function deleteEvent() {
        if (currentEditingEvent) {
          currentEditingEvent.element.remove();
          updateStats();
          saveToLocalStorage();
          if (currentUser && supabaseClient) {
            saveToSupabase();
          }
        }
        closeModal();
      }

      function checkConflicts(slot, type) {
        const events = slot.querySelectorAll(".event");
        for (let event of events) {
          if (type === "uni" && event.classList.contains("event-work1"))
            return true;
          if (type === "uni" && event.classList.contains("event-work2"))
            return true;
          if (type === "work1" && event.classList.contains("event-uni"))
            return true;
          if (type === "work2" && event.classList.contains("event-uni"))
            return true;
        }
        return false;
      }

      document.getElementById("eventForm").onsubmit = function (e) {
        e.preventDefault();

        const data = {
          type: document.getElementById("eventType").value,
          title: document.getElementById("eventTitle").value,
          location: document.getElementById("eventLocation").value,
          notes: document.getElementById("eventNotes").value,
        };

        if (currentEditingEvent) {
          currentEditingEvent.element.remove();
        }

        const targetSlot = currentEditingEvent
          ? currentEditingEvent.element.parentElement
          : currentSlot;

        if (checkConflicts(targetSlot, data.type)) {
          document.getElementById("conflictWarning").style.display = "block";
          setTimeout(() => {
            document.getElementById("conflictWarning").style.display = "none";
          }, 5000);
        }

        const event = createEvent(data);
        targetSlot.appendChild(event);

        updateStats();
        saveToLocalStorage();
        if (currentUser && supabaseClient) {
          saveToSupabase();
        }
        closeModal();
      };

      function updateWeekDisplay() {
        const endDate = new Date(currentWeekStart);
        endDate.setDate(endDate.getDate() + 6);

        const startStr = `${currentWeekStart.getDate()} ${getMonthName(
          currentWeekStart.getMonth()
        )}`;
        const endStr = `${endDate.getDate()} ${getMonthName(
          endDate.getMonth()
        )} ${endDate.getFullYear()}`;

        document.getElementById(
          "weekDisplay"
        ).textContent = `Settimana del ${startStr} - ${endStr}`;
      }

      function getMonthName(monthIndex) {
        const months = [
          "Gen",
          "Feb",
          "Mar",
          "Apr",
          "Mag",
          "Giu",
          "Lug",
          "Ago",
          "Set",
          "Ott",
          "Nov",
          "Dic",
        ];
        return months[monthIndex];
      }

      function previousWeek() {
        currentWeekStart.setDate(currentWeekStart.getDate() - 7);
        initializeSchedule();
        if (currentUser && supabaseClient) {
          loadFromSupabase();
        }
      }

      function nextWeek() {
        currentWeekStart.setDate(currentWeekStart.getDate() + 7);
        initializeSchedule();
        if (currentUser && supabaseClient) {
          loadFromSupabase();
        }
      }

      function updateStats() {
        let uniHours = 0,
          work1Hours = 0,
          work2Hours = 0,
          conflicts = 0;

        document.querySelectorAll(".slot").forEach((slot) => {
          const events = slot.querySelectorAll(".event");
          let hasUni = false,
            hasWork1 = false,
            hasWork2 = false;

          events.forEach((event) => {
            if (event.classList.contains("event-uni")) {
              uniHours++;
              hasUni = true;
            }
            if (event.classList.contains("event-work1")) {
              work1Hours++;
              hasWork1 = true;
            }
            if (event.classList.contains("event-work2")) {
              work2Hours++;
              hasWork2 = true;
            }
          });

          if ((hasUni && hasWork1) || (hasUni && hasWork2)) {
            conflicts++;
          }
        });

        document.getElementById("uniHours").textContent = uniHours;
        document.getElementById("work1Hours").textContent = work1Hours;
        document.getElementById("work2Hours").textContent = work2Hours;
        document.getElementById("conflicts").textContent = conflicts;
      }

      function saveToLocalStorage() {
        const weekKey = `week_${currentWeekStart.toISOString().split("T")[0]}`;
        const weekData = {};

        document.querySelectorAll(".slot").forEach((slot) => {
          const key = `${slot.dataset.day}_${slot.dataset.time}`;
          const events = [];

          slot.querySelectorAll(".event").forEach((event) => {
            const type = event.classList.contains("event-uni")
              ? "uni"
              : event.classList.contains("event-work1")
              ? "work1"
              : "work2";
            const title = event.querySelector("strong").textContent;
            const locationEl = event.querySelector("small");

            events.push({
              type,
              title,
              location: locationEl ? locationEl.textContent : "",
            });
          });

          if (events.length > 0) {
            weekData[key] = events;
          }
        });

        localStorage.setItem(weekKey, JSON.stringify(weekData));
      }

      function loadEvents() {
        const weekKey = `week_${currentWeekStart.toISOString().split("T")[0]}`;
        const savedData = localStorage.getItem(weekKey);

        if (savedData) {
          const weekData = JSON.parse(savedData);

          Object.entries(weekData).forEach(([key, events]) => {
            const [day, time] = key.split("_");
            const slot = document.querySelector(
              `[data-day="${day}"][data-time="${time}"]`
            );

            if (slot) {
              events.forEach((eventData) => {
                const event = createEvent(eventData);
                slot.appendChild(event);
              });
            }
          });

          updateStats();
        }
      }

      function exportToCSV() {
        let csv = "Data,Giorno,Ora,Tipo,Titolo,Luogo,Note\n";

        days.forEach((day, dayIndex) => {
          timeSlots.forEach((time) => {
            const slot = document.querySelector(
              `[data-day="${dayIndex}"][data-time="${time}"]`
            );
            const events = slot.querySelectorAll(".event");

            events.forEach((event) => {
              const date = new Date(currentWeekStart);
              date.setDate(date.getDate() + dayIndex);
              const dateStr = date.toLocaleDateString("it-IT");

              const type = event.classList.contains("event-uni")
                ? "Universit√†"
                : event.classList.contains("event-work1")
                ? "Lavoro P1"
                : "Lavoro P2";
              const title = event.querySelector("strong").textContent;
              const location = event.querySelector("small")
                ? event.querySelector("small").textContent
                : "";

              csv += `${dateStr},${day},${time},${type},"${title}","${location}",""\n`;
            });
          });
        });

        const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = `orario_settimana_${
          currentWeekStart.toISOString().split("T")[0]
        }.csv`;
        link.click();
      }

      function saveToLocal() {
        saveToLocalStorage();
        alert("Dati salvati localmente! Potrai ricaricarli in futuro.");
      }

      function loadFromLocal() {
        loadEvents();
        alert("Dati caricati con successo!");
      }

      // Initialize on load
      window.onload = function () {
        initializeSchedule();
        initSupabase();
      };

      // Close modal when clicking outside
      window.onclick = function (event) {
        if (event.target == document.getElementById("eventModal")) {
          closeModal();
        }
      };
    </script>
  </body>
</html>
