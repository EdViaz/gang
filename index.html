<!DOCTYPE html>
<html lang="it">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
    <title>Pianificatore Orario Universit√† e Lavoro</title>
    <link rel="stylesheet" href="style.css" />
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üìö</text></svg>">
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>üìö Pianificatore Orario Universit√† e Lavoro</h1>
      </div>

      <div class="controls">
        <div class="week-selector">
          <button onclick="previousWeek()">‚Üê Settimana precedente</button>
          <div class="week-display" id="weekDisplay">
            Settimana del 25 Nov - 1 Dic 2024
          </div>
          <button onclick="nextWeek()">Settimana successiva ‚Üí</button>
        </div>
        <div class="legend">
          <div class="legend-item">
            <div class="legend-box" style="background-color: #3498db"></div>
            <span>Universit√†</span>
          </div>
          <div class="legend-item">
            <div class="legend-box" style="background-color: #e74c3c"></div>
            <span>Leo</span>
          </div>
          <div class="legend-item">
            <div class="legend-box" style="background-color: #f39c12"></div>
            <span>Edo</span>
          </div>
        </div>
      </div>

      <div class="schedule-container">
        <div class="schedule-grid" id="scheduleGrid">
          <!-- Grid will be generated by JavaScript -->
        </div>
      </div>

      <div class="stats-container">
        <h3 style="margin-bottom: 20px; color: #333">Riepilogo Settimanale</h3>
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-value" id="uniHours">0</div>
            <div class="stat-label">Ore di Universit√†</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="work1Hours">0</div>
            <div class="stat-label">Ore Leo</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="work2Hours">0</div>
            <div class="stat-label">Ore Edo</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="conflicts">0</div>
            <div class="stat-label">Conflitti Orari</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal for adding/editing events -->
    <div id="eventModal" class="modal">
      <div class="modal-content">
        <span class="close" onclick="closeModal()">&times;</span>
        <h2 id="modalTitle">Aggiungi Evento</h2>
        <form id="eventForm">
          <div class="form-group">
            <label for="eventType">Tipo di evento:</label>
            <select id="eventType" required>
              <option value="uni">Lezione Universit√†</option>
              <option value="work1">Leo</option>
              <option value="work2">Edo</option>
            </select>
          </div>
          <div class="form-group">
            <label for="eventTitle">Titolo:</label>
            <input
              type="text"
              id="eventTitle"
              required
              placeholder="es. Analisi Matematica, Turno Bar"
            />
          </div>
          <div class="form-group">
            <label for="eventTime">Orario personalizzato (opzionale):</label>
            <div style="display: flex; gap: 10px; align-items: center;">
              <input
                type="time"
                id="eventStartTime"
                placeholder="Inizio"
                style="width: 120px;"
              />
              <span>-</span>
              <input
                type="time"
                id="eventEndTime"
                placeholder="Fine"
                style="width: 120px;"
              />
              <small style="color: #666; margin-left: 10px;">
                Lascia vuoto per usare l'orario del slot (1 ora)
              </small>
            </div>
          </div>
          <div class="form-group">
            <label for="eventLocation">Luogo/Aula:</label>
            <input
              type="text"
              id="eventLocation"
              placeholder="es. Aula 3, Via Roma 10"
            />
          </div>
          <div class="form-group">
            <label for="eventNotes">Note:</label>
            <textarea
              id="eventNotes"
              rows="3"
              placeholder="Aggiungi note..."
            ></textarea>
          </div>
          <div class="conflict-warning" id="conflictWarning">
            ‚ö†Ô∏è Attenzione: C'√® un conflitto con un altro evento in questo
            orario!
          </div>
          <div class="button-group">
            <button type="submit" class="btn-save">Salva</button>
            <button type="button" class="btn-cancel" onclick="closeModal()">
              Annulla
            </button>
            <button
              type="button"
              class="btn-delete"
              id="deleteBtn"
              onclick="deleteEvent()"
              style="display: none"
            >
              Elimina
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Script Supabase -->
    <script>
      // Configurazione base
      let currentWeekStart = new Date();
      currentWeekStart.setDate(
        currentWeekStart.getDate() - currentWeekStart.getDay() + 1
      );

      let events = {};
      let currentEditingEvent = null;
      let currentSlot = null;
      let draggedEvent = null;

      // Configurazione base

      const timeSlots = [
        "08:00",
        "09:00",
        "10:00",
        "11:00",
        "12:00",
        "13:00",
        "14:00",
        "15:00",
        "16:00",
        "17:00",
        "18:00",
        "19:00",
        "20:00",
        "21:00",
      ];

      const days = ["Luned√¨", "Marted√¨", "Mercoled√¨", "Gioved√¨"];

      function initializeSchedule() {
        const grid = document.getElementById("scheduleGrid");
        grid.innerHTML = "";

        // Add header row
        grid.appendChild(createCell("time-header", "Orario"));
        days.forEach((day) => {
          grid.appendChild(createCell("day-header", day));
        });

        // Add time slots
        timeSlots.forEach((time, timeIndex) => {
          grid.appendChild(createCell("time-slot", time));

          days.forEach((day, dayIndex) => {
            const slot = createCell("slot", "");
            slot.dataset.time = time;
            slot.dataset.day = dayIndex;
            slot.dataset.timeIndex = timeIndex;
            slot.onclick = function () {
              openModal(this);
            };
            
            // Aggiungi listener per drag and drop
            slot.addEventListener('dragover', handleDragOver);
            slot.addEventListener('drop', handleDrop);
            
            grid.appendChild(slot);
          });
        });

        updateWeekDisplay();
        loadEvents();
      }

      function createCell(className, content) {
        const cell = document.createElement("div");
        cell.className = className;
        cell.textContent = content;
        return cell;
      }

      function openModal(slot) {
        currentSlot = slot;
        currentEditingEvent = null;
        document.getElementById("modalTitle").textContent = "Aggiungi Evento";
        document.getElementById("eventForm").reset();
        
        // Auto-compila gli orari basandosi sul slot selezionato
        const slotTime = slot.dataset.time;
        if (slotTime) {
          const startTime = slotTime;
          const endTime = getNextHour(slotTime);
          document.getElementById("eventStartTime").value = startTime;
          document.getElementById("eventEndTime").value = endTime;
        } else {
          document.getElementById("eventStartTime").value = "";
          document.getElementById("eventEndTime").value = "";
        }
        
        document.getElementById("deleteBtn").style.display = "none";
        document.getElementById("conflictWarning").style.display = "none";
        document.getElementById("eventModal").style.display = "block";
      }

      function getNextHour(timeString) {
        const [hours, minutes] = timeString.split(':').map(Number);
        const nextHour = hours + 1;
        return `${nextHour.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
      }

      function closeModal() {
        document.getElementById("eventModal").style.display = "none";
        currentSlot = null;
        currentEditingEvent = null;
      }

      function createEvent(data) {
        const event = document.createElement("div");
        event.className = `event event-${data.type}`;
        event.draggable = true;
        
        // Costruisci il contenuto dell'evento
        let eventContent = `<strong>${data.title}</strong>`;
        
        // Aggiungi orario personalizzato se presente
        if (data.startTime && data.endTime) {
          eventContent += `<br><small>‚è∞ ${data.startTime} - ${data.endTime}</small>`;
        }
        
        // Aggiungi location se presente
        if (data.location) {
          eventContent += `<br><small>üìç ${data.location}</small>`;
        }
        
        event.innerHTML = eventContent;
        
        // Event listeners per drag and drop
        event.addEventListener('dragstart', handleDragStart);
        event.addEventListener('dragend', handleDragEnd);
        
        event.onclick = function (e) {
          e.stopPropagation();
          editEvent(data, event);
        };
        
        return event;
      }

      function findBestSlotForTime(startTime, endTime) {
        if (!startTime || !endTime) return null;
        
        const startMinutes = timeToMinutes(startTime);
        const endMinutes = timeToMinutes(endTime);
        
        // Trova il time slot pi√π vicino all'orario di inizio
        let bestSlotIndex = 0;
        let minDifference = Infinity;
        
        timeSlots.forEach((slot, index) => {
          const slotMinutes = timeToMinutes(slot);
          const difference = Math.abs(slotMinutes - startMinutes);
          
          if (difference < minDifference) {
            minDifference = difference;
            bestSlotIndex = index;
          }
        });
        
        return bestSlotIndex;
      }

      function positionEventInCorrectSlot(eventElement, data, currentSlot) {
        if (data.startTime && data.endTime) {
          const bestSlotIndex = findBestSlotForTime(data.startTime, data.endTime);
          
          if (bestSlotIndex !== null) {
            // Trova il nuovo slot corretto usando il time slot corrispondente
            const dayIndex = currentSlot.dataset.day;
            const targetTime = timeSlots[bestSlotIndex];
            const newSlot = document.querySelector(
              `[data-day="${dayIndex}"][data-time="${targetTime}"]`
            );
            
            if (newSlot && newSlot !== currentSlot) {
              // Sposta l'evento nel slot corretto
              newSlot.appendChild(eventElement);
              currentSlot = newSlot;
            }
          }
          
          // Applica il posizionamento fine all'interno del slot
          positionEventByTime(eventElement, data.startTime, data.endTime);
        }
        
        return currentSlot;
      }

      function positionEventByTime(eventElement, startTime, endTime) {
        // Calcola la posizione in base all'orario
        const startMinutes = timeToMinutes(startTime);
        const endMinutes = timeToMinutes(endTime);
        const duration = endMinutes - startMinutes;
        
        // Trova l'ora del slot corrente
        const parentSlot = eventElement.parentElement;
        if (!parentSlot || !parentSlot.dataset.time) return;
        
        const slotTime = parentSlot.dataset.time;
        const slotMinutes = timeToMinutes(slotTime);
        
        // Calcola l'offset dall'inizio del slot
        const offsetFromSlot = startMinutes - slotMinutes;
        
        // Ogni minuto corrisponde a circa 1px (60px per ora)
        const pixelsPerMinute = 1;
        const topOffset = offsetFromSlot * pixelsPerMinute;
        const height = duration * pixelsPerMinute;
        
        // Applica il posizionamento solo se l'evento inizia nel slot corrente
        if (offsetFromSlot >= 0 && offsetFromSlot < 60) {
          eventElement.style.top = `${topOffset}px`;
          eventElement.style.height = `${Math.max(height, 30)}px`;
          eventElement.style.zIndex = '5';
          eventElement.style.position = 'relative';
        }
      }

      function timeToMinutes(timeString) {
        const [hours, minutes] = timeString.split(':').map(Number);
        return hours * 60 + minutes;
      }

      function minutesToTime(minutes) {
        const hours = Math.floor(minutes / 60);
        const mins = minutes % 60;
        return `${hours.toString().padStart(2, '0')}:${mins.toString().padStart(2, '0')}`;
      }

      function handleDragStart(e) {
        draggedEvent = e.target;
        e.target.style.opacity = '0.5';
      }

      function handleDragEnd(e) {
        e.target.style.opacity = '1';
        draggedEvent = null;
      }

      function handleDragOver(e) {
        e.preventDefault();
      }

      function handleDrop(e) {
        e.preventDefault();
        if (draggedEvent && e.target.classList.contains('slot')) {
          // Rimuovi l'evento dalla posizione originale
          const originalParent = draggedEvent.parentElement;
          
          // Aggiungi l'evento alla nuova posizione
          e.target.appendChild(draggedEvent);
          
          // Reset del posizionamento personalizzato se non ha orari specifici
          const hasCustomTime = draggedEvent.querySelector('small') && 
                               draggedEvent.querySelector('small').textContent.includes('‚è∞');
          
          if (!hasCustomTime) {
            draggedEvent.style.top = '';
            draggedEvent.style.height = '';
            draggedEvent.style.zIndex = '';
          }
          
          // Aggiorna le statistiche
          updateStats();
          saveToLocalStorage();
        }
      }

      function editEvent(data, eventElement) {
        currentEditingEvent = { data, element: eventElement };
        document.getElementById("modalTitle").textContent = "Modifica Evento";
        document.getElementById("eventType").value = data.type;
        document.getElementById("eventTitle").value = data.title;
        document.getElementById("eventStartTime").value = data.startTime || "";
        document.getElementById("eventEndTime").value = data.endTime || "";
        document.getElementById("eventLocation").value = data.location || "";
        document.getElementById("eventNotes").value = data.notes || "";
        document.getElementById("deleteBtn").style.display = "block";
        document.getElementById("eventModal").style.display = "block";
      }

      function deleteEvent() {
        if (currentEditingEvent) {
          currentEditingEvent.element.remove();
          updateStats();
          saveToLocalStorage();
        }
        closeModal();
      }

      function checkConflicts(slot, type) {
        const events = slot.querySelectorAll(".event");
        for (let event of events) {
          if (type === "uni" && event.classList.contains("event-work1"))
            return true;
          if (type === "uni" && event.classList.contains("event-work2"))
            return true;
          if (type === "work1" && event.classList.contains("event-uni"))
            return true;
          if (type === "work2" && event.classList.contains("event-uni"))
            return true;
        }
        return false;
      }

      document.getElementById("eventForm").onsubmit = function (e) {
        e.preventDefault();

        const data = {
          type: document.getElementById("eventType").value,
          title: document.getElementById("eventTitle").value,
          startTime: document.getElementById("eventStartTime").value,
          endTime: document.getElementById("eventEndTime").value,
          location: document.getElementById("eventLocation").value,
          notes: document.getElementById("eventNotes").value,
        };

        // Validazione orari personalizzati
        if (data.startTime && !data.endTime) {
          alert("Se inserisci l'orario di inizio, devi inserire anche quello di fine!");
          return;
        }
        if (!data.startTime && data.endTime) {
          alert("Se inserisci l'orario di fine, devi inserire anche quello di inizio!");
          return;
        }
        if (data.startTime && data.endTime && data.startTime >= data.endTime) {
          alert("L'orario di fine deve essere successivo a quello di inizio!");
          return;
        }

        // Determina il slot target prima di rimuovere l'evento
        let targetSlot = currentSlot;
        if (currentEditingEvent) {
          targetSlot = currentEditingEvent.element.parentElement;
        }

        // Solo ora rimuovi l'evento esistente
        if (currentEditingEvent) {
          currentEditingEvent.element.remove();
        }

        if (checkConflicts(targetSlot, data.type)) {
          document.getElementById("conflictWarning").style.display = "block";
          setTimeout(() => {
            document.getElementById("conflictWarning").style.display = "none";
          }, 5000);
        }

        const event = createEvent(data);
        let finalSlot = targetSlot;
        
        // Se ha orari personalizzati, trova il slot corretto
        if (data.startTime && data.endTime) {
          const bestSlotIndex = findBestSlotForTime(data.startTime, data.endTime);
          if (bestSlotIndex !== null) {
            const dayIndex = targetSlot.dataset.day;
            const targetTime = timeSlots[bestSlotIndex];
            const newSlot = document.querySelector(
              `[data-day="${dayIndex}"][data-time="${targetTime}"]`
            );
            
            if (newSlot) {
              finalSlot = newSlot;
            }
          }
        }
        
        finalSlot.appendChild(event);

        // Applica il posizionamento fine se necessario
        if (data.startTime && data.endTime) {
          positionEventByTime(event, data.startTime, data.endTime);
        }

        updateStats();
        saveToLocalStorage();
        closeModal();
      };

      function updateWeekDisplay() {
        const endDate = new Date(currentWeekStart);
        endDate.setDate(endDate.getDate() + 6);

        const startStr = `${currentWeekStart.getDate()} ${getMonthName(
          currentWeekStart.getMonth()
        )}`;
        const endStr = `${endDate.getDate()} ${getMonthName(
          endDate.getMonth()
        )} ${endDate.getFullYear()}`;

        document.getElementById(
          "weekDisplay"
        ).textContent = `Settimana del ${startStr} - ${endStr}`;
      }

      function getMonthName(monthIndex) {
        const months = [
          "Gen",
          "Feb",
          "Mar",
          "Apr",
          "Mag",
          "Giu",
          "Lug",
          "Ago",
          "Set",
          "Ott",
          "Nov",
          "Dic",
        ];
        return months[monthIndex];
      }

      function previousWeek() {
        currentWeekStart.setDate(currentWeekStart.getDate() - 7);
        initializeSchedule();
      }

      function nextWeek() {
        currentWeekStart.setDate(currentWeekStart.getDate() + 7);
        initializeSchedule();
      }

      function updateStats() {
        let uniHours = 0,
          work1Hours = 0,
          work2Hours = 0,
          conflicts = 0;

        document.querySelectorAll(".slot").forEach((slot) => {
          const events = slot.querySelectorAll(".event");
          let hasUni = false,
            hasWork1 = false,
            hasWork2 = false;

          events.forEach((event) => {
            if (event.classList.contains("event-uni")) {
              uniHours++;
              hasUni = true;
            }
            if (event.classList.contains("event-work1")) {
              work1Hours++;
              hasWork1 = true;
            }
            if (event.classList.contains("event-work2")) {
              work2Hours++;
              hasWork2 = true;
            }
          });

          if ((hasUni && hasWork1) || (hasUni && hasWork2)) {
            conflicts++;
          }
        });

        document.getElementById("uniHours").textContent = uniHours;
        document.getElementById("work1Hours").textContent = work1Hours;
        document.getElementById("work2Hours").textContent = work2Hours;
        document.getElementById("conflicts").textContent = conflicts;
      }

      function saveToLocalStorage() {
        const weekKey = `week_${currentWeekStart.toISOString().split("T")[0]}`;
        const weekData = {};

        document.querySelectorAll(".slot").forEach((slot) => {
          const key = `${slot.dataset.day}_${slot.dataset.time}`;
          const events = [];

          slot.querySelectorAll(".event").forEach((event) => {
            const type = event.classList.contains("event-uni")
              ? "uni"
              : event.classList.contains("event-work1")
              ? "work1"
              : "work2";
            const title = event.querySelector("strong").textContent;
            
            // Estrai orari personalizzati se presenti
            const timeEl = event.querySelector("small");
            let startTime = "", endTime = "", location = "";
            
            if (timeEl && timeEl.textContent.includes("‚è∞")) {
              const timeText = timeEl.textContent.replace("‚è∞ ", "");
              const timeParts = timeText.split(" - ");
              if (timeParts.length === 2) {
                startTime = timeParts[0];
                endTime = timeParts[1];
              }
              // Cerca location nel secondo small element
              const locationEl = event.querySelector("small:nth-of-type(2)");
              if (locationEl && locationEl.textContent.includes("üìç")) {
                location = locationEl.textContent.replace("üìç ", "");
              }
            } else if (timeEl && timeEl.textContent.includes("üìç")) {
              // Solo location, nessun orario personalizzato
              location = timeEl.textContent.replace("üìç ", "");
            }

            events.push({
              type,
              title,
              startTime,
              endTime,
              location,
            });
          });

          if (events.length > 0) {
            weekData[key] = events;
          }
        });

        localStorage.setItem(weekKey, JSON.stringify(weekData));
      }

      function loadEvents() {
        const weekKey = `week_${currentWeekStart.toISOString().split("T")[0]}`;
        const savedData = localStorage.getItem(weekKey);

        if (savedData) {
          const weekData = JSON.parse(savedData);

          Object.entries(weekData).forEach(([key, events]) => {
            const [day, time] = key.split("_");
            const slot = document.querySelector(
              `[data-day="${day}"][data-time="${time}"]`
            );

            if (slot) {
              events.forEach((eventData) => {
                const event = createEvent(eventData);
                
                // Se ha orari personalizzati, trova il slot corretto
                if (eventData.startTime && eventData.endTime) {
                  const bestSlotIndex = findBestSlotForTime(eventData.startTime, eventData.endTime);
                  if (bestSlotIndex !== null) {
                    const targetTime = timeSlots[bestSlotIndex];
                    const correctSlot = document.querySelector(
                      `[data-day="${day}"][data-time="${targetTime}"]`
                    );
                    if (correctSlot) {
                      correctSlot.appendChild(event);
                      positionEventByTime(event, eventData.startTime, eventData.endTime);
                    } else {
                      slot.appendChild(event);
                    }
                  } else {
                    slot.appendChild(event);
                  }
                } else {
                  slot.appendChild(event);
                }
              });
            }
          });

          updateStats();
        }
      }

      // Initialize on load
      window.onload = function () {
        initializeSchedule();
      };

      // Close modal when clicking outside
      window.onclick = function (event) {
        if (event.target == document.getElementById("eventModal")) {
          closeModal();
        }
      };
    </script>
  </body>
</html>
