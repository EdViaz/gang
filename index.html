<!DOCTYPE html>
<html lang="it">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Pianificatore Orario Universit√† e Lavoro</title>
    <link rel="stylesheet" href="style.css" />
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üìö</text></svg>">
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>üìö Pianificatore Orario Universit√† e Lavoro</h1>
      </div>

      <div class="controls">
        <div class="week-selector">
          <button onclick="previousWeek()">‚Üê Settimana precedente</button>
          <div class="week-display" id="weekDisplay">
            Settimana del 25 Nov - 1 Dic 2024
          </div>
          <button onclick="nextWeek()">Settimana successiva ‚Üí</button>
        </div>
        <div class="legend">
          <div class="legend-item">
            <div class="legend-box" style="background-color: #3498db"></div>
            <span>Universit√†</span>
          </div>
          <div class="legend-item">
            <div class="legend-box" style="background-color: #e74c3c"></div>
            <span>Lavoro P1</span>
          </div>
          <div class="legend-item">
            <div class="legend-box" style="background-color: #f39c12"></div>
            <span>Lavoro P2</span>
          </div>
        </div>
      </div>

      <div class="schedule-container">
        <div class="schedule-grid" id="scheduleGrid">
          <!-- Grid will be generated by JavaScript -->
        </div>
      </div>

      <div class="stats-container">
        <h3 style="margin-bottom: 20px; color: #333">Riepilogo Settimanale</h3>
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-value" id="uniHours">0</div>
            <div class="stat-label">Ore di Universit√†</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="work1Hours">0</div>
            <div class="stat-label">Ore Lavoro Persona 1</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="work2Hours">0</div>
            <div class="stat-label">Ore Lavoro Persona 2</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="conflicts">0</div>
            <div class="stat-label">Conflitti Orari</div>
          </div>
        </div>
      </div>

      <div class="export-section">
        <h3>Gestione Dati</h3>
        <p>I tuoi dati vengono salvati automaticamente online e localmente</p>
        <div id="authSection" style="margin-bottom: 20px">
          <input
            type="email"
            id="userEmail"
            placeholder="La tua email"
            style="width: 250px; margin-right: 10px"
          />
          <button onclick="signUp()" id="signUpBtn">üîê Registrati</button>
          <button onclick="signIn()" id="signInBtn">üîë Accedi</button>
          <button onclick="signOut()" id="signOutBtn" style="display: none">
            üö™ Esci
          </button>
        </div>
        <div
          id="userInfo"
          style="display: none; margin-bottom: 15px; color: #27ae60"
        >
          üë§ Connesso come: <span id="userEmailDisplay"></span>
        </div>
        <button onclick="exportToCSV()">üìä Esporta in CSV</button>
        <button onclick="saveToLocal()">üíæ Salva Locale</button>
        <button onclick="loadFromLocal()">üìÇ Carica Dati Salvati</button>
        <button onclick="syncData()" id="syncBtn" style="display: none">
          üîÑ Sincronizza Online
        </button>
      </div>
    </div>

    <!-- Modal for adding/editing events -->
    <div id="eventModal" class="modal">
      <div class="modal-content">
        <span class="close" onclick="closeModal()">&times;</span>
        <h2 id="modalTitle">Aggiungi Evento</h2>
        <form id="eventForm">
          <div class="form-group">
            <label for="eventType">Tipo di evento:</label>
            <select id="eventType" required>
              <option value="uni">Lezione Universit√†</option>
              <option value="work1">Turno Lavoro - Persona 1</option>
              <option value="work2">Turno Lavoro - Persona 2</option>
            </select>
          </div>
          <div class="form-group">
            <label for="eventTitle">Titolo:</label>
            <input
              type="text"
              id="eventTitle"
              required
              placeholder="es. Analisi Matematica, Turno Bar"
            />
          </div>
          <div class="form-group">
            <label for="eventLocation">Luogo/Aula:</label>
            <input
              type="text"
              id="eventLocation"
              placeholder="es. Aula 3, Via Roma 10"
            />
          </div>
          <div class="form-group">
            <label for="eventNotes">Note:</label>
            <textarea
              id="eventNotes"
              rows="3"
              placeholder="Aggiungi note..."
            ></textarea>
          </div>
          <div class="conflict-warning" id="conflictWarning">
            ‚ö†Ô∏è Attenzione: C'√® un conflitto con un altro evento in questo
            orario!
          </div>
          <div class="button-group">
            <button type="submit" class="btn-save">Salva</button>
            <button type="button" class="btn-cancel" onclick="closeModal()">
              Annulla
            </button>
            <button
              type="button"
              class="btn-delete"
              id="deleteBtn"
              onclick="deleteEvent()"
              style="display: none"
            >
              Elimina
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Script Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
      // Inizializzazione Supabase
      async function initSupabase() {
        try {
          if (SUPABASE_URL !== "https://your-project.supabase.co") {
            const { createClient } = supabase;
            supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

            // Controlla se l'utente √® gi√† autenticato
            const {
              data: { user },
            } = await supabaseClient.auth.getUser();
            if (user) {
              currentUser = user;
              updateAuthUI(true);
              loadFromSupabase();
            }
          }
        } catch (error) {
          console.log("Supabase non configurato, usando solo storage locale");
        }
      }

      async function signUp() {
        const email = document.getElementById("userEmail").value;
        if (!email || !supabaseClient) return;

        try {
          const { data, error } = await supabaseClient.auth.signUp({
            email: email,
            password:
              "temp-password-" + Math.random().toString(36).substring(7),
          });

          if (error) throw error;
          alert("Controlla la tua email per il link di conferma!");
        } catch (error) {
          alert("Errore registrazione: " + error.message);
        }
      }

      async function signIn() {
        const email = document.getElementById("userEmail").value;
        if (!email || !supabaseClient) return;

        try {
          const { data, error } = await supabaseClient.auth.signInWithOtp({
            email: email,
          });

          if (error) throw error;
          alert("Controlla la tua email per il link di accesso!");
        } catch (error) {
          alert("Errore accesso: " + error.message);
        }
      }

      async function signOut() {
        if (!supabaseClient) return;

        await supabaseClient.auth.signOut();
        currentUser = null;
        updateAuthUI(false);
      }

      function updateAuthUI(isLoggedIn) {
        document.getElementById("signUpBtn").style.display = isLoggedIn
          ? "none"
          : "inline-block";
        document.getElementById("signInBtn").style.display = isLoggedIn
          ? "none"
          : "inline-block";
        document.getElementById("signOutBtn").style.display = isLoggedIn
          ? "inline-block"
          : "none";
        document.getElementById("syncBtn").style.display = isLoggedIn
          ? "inline-block"
          : "none";
        document.getElementById("userInfo").style.display = isLoggedIn
          ? "block"
          : "none";

        if (isLoggedIn && currentUser) {
          document.getElementById("userEmailDisplay").textContent =
            currentUser.email;
        }
      }

      async function saveToSupabase() {
        if (!supabaseClient || !currentUser) return;

        const weekKey = `week_${currentWeekStart.toISOString().split("T")[0]}`;
        const weekData = {};

        document.querySelectorAll(".slot").forEach((slot) => {
          const key = `${slot.dataset.day}_${slot.dataset.time}`;
          const events = [];

          slot.querySelectorAll(".event").forEach((event) => {
            const type = event.classList.contains("event-uni")
              ? "uni"
              : event.classList.contains("event-work1")
              ? "work1"
              : "work2";
            const title = event.querySelector("strong").textContent;
            const locationEl = event.querySelector("small");

            events.push({
              type,
              title,
              location: locationEl ? locationEl.textContent : "",
            });
          });

          if (events.length > 0) {
            weekData[key] = events;
          }
        });

        try {
          const { error } = await supabaseClient.from("schedules").upsert({
            user_id: currentUser.id,
            week_key: weekKey,
            data: weekData,
            updated_at: new Date().toISOString(),
          });

          if (error) throw error;
        } catch (error) {
          console.error("Errore salvataggio online:", error);
        }
      }

      async function loadFromSupabase() {
        if (!supabaseClient || !currentUser) return;

        const weekKey = `week_${currentWeekStart.toISOString().split("T")[0]}`;

        try {
          const { data, error } = await supabaseClient
            .from("schedules")
            .select("data")
            .eq("user_id", currentUser.id)
            .eq("week_key", weekKey)
            .single();

          if (error && error.code !== "PGRST116") throw error;

          if (data && data.data) {
            // Pulisci gli eventi esistenti
            document
              .querySelectorAll(".event")
              .forEach((event) => event.remove());

            Object.entries(data.data).forEach(([key, events]) => {
              const [day, time] = key.split("_");
              const slot = document.querySelector(
                `[data-day="${day}"][data-time="${time}"]`
              );

              if (slot) {
                events.forEach((eventData) => {
                  const event = createEvent(eventData);
                  slot.appendChild(event);
                });
              }
            });

            updateStats();
          }
        } catch (error) {
          console.error("Errore caricamento online:", error);
        }
      }

      async function syncData() {
        await saveToSupabase();
        await loadFromSupabase();
        alert("Dati sincronizzati con successo!");
      }

      // Listener per cambio autenticazione
      if (typeof supabase !== "undefined" && SUPABASE_URL !== "https://your-project.supabase.co") {
        const { createClient } = supabase;
        const tempClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        tempClient.auth.onAuthStateChange((event, session) => {
          if (event === "SIGNED_IN") {
            currentUser = session.user;
            updateAuthUI(true);
            loadFromSupabase();
          } else if (event === "SIGNED_OUT") {
            currentUser = null;
            updateAuthUI(false);
          }
        });
      }

      // Configurazione Supabase (sostituisci con le tue credenziali)
      // Configurazione Supabase (sostituisci con le tue credenziali)
      const SUPABASE_URL = "https://sfpoczkspfgecqexsjlk.supabase.co";
      const SUPABASE_ANON_KEY =
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNmcG9jemtzcGZnZWNxZXhzamxrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkxODIzMzMsImV4cCI6MjA3NDc1ODMzM30.AuI9HT9KwL4nDfUWT6aw3Q0nB9iwGMFLVunz9X7WAQw";

      let supabaseClient = null;
      let currentUser = null;

      let currentWeekStart = new Date();
      currentWeekStart.setDate(
        currentWeekStart.getDate() - currentWeekStart.getDay() + 1
      );

      let events = {};
      let currentEditingEvent = null;
      let currentSlot = null;

      const timeSlots = [
        "08:00",
        "09:00",
        "10:00",
        "11:00",
        "12:00",
        "13:00",
        "14:00",
        "15:00",
        "16:00",
        "17:00",
        "18:00",
        "19:00",
        "20:00",
        "21:00",
      ];

      const days = ["Luned√¨", "Marted√¨", "Mercoled√¨", "Gioved√¨"];

      function initializeSchedule() {
        const grid = document.getElementById("scheduleGrid");
        grid.innerHTML = "";

        // Add header row
        grid.appendChild(createCell("time-header", "Orario"));
        days.forEach((day) => {
          grid.appendChild(createCell("day-header", day));
        });

        // Add time slots
        timeSlots.forEach((time, timeIndex) => {
          grid.appendChild(createCell("time-slot", time));

          days.forEach((day, dayIndex) => {
            const slot = createCell("slot", "");
            slot.dataset.time = time;
            slot.dataset.day = dayIndex;
            slot.dataset.timeIndex = timeIndex;
            slot.onclick = function () {
              openModal(this);
            };
            grid.appendChild(slot);
          });
        });

        updateWeekDisplay();
        loadEvents();
      }

      function createCell(className, content) {
        const cell = document.createElement("div");
        cell.className = className;
        cell.textContent = content;
        return cell;
      }

      function openModal(slot) {
        currentSlot = slot;
        currentEditingEvent = null;
        document.getElementById("modalTitle").textContent = "Aggiungi Evento";
        document.getElementById("eventForm").reset();
        document.getElementById("deleteBtn").style.display = "none";
        document.getElementById("conflictWarning").style.display = "none";
        document.getElementById("eventModal").style.display = "block";
      }

      function closeModal() {
        document.getElementById("eventModal").style.display = "none";
        currentSlot = null;
        currentEditingEvent = null;
      }

      function createEvent(data) {
        const event = document.createElement("div");
        event.className = `event event-${data.type}`;
        event.innerHTML = `
                <strong>${data.title}</strong>
                ${data.location ? `<br><small>${data.location}</small>` : ""}
            `;
        event.onclick = function (e) {
          e.stopPropagation();
          editEvent(data, event);
        };
        return event;
      }

      function editEvent(data, eventElement) {
        currentEditingEvent = { data, element: eventElement };
        document.getElementById("modalTitle").textContent = "Modifica Evento";
        document.getElementById("eventType").value = data.type;
        document.getElementById("eventTitle").value = data.title;
        document.getElementById("eventLocation").value = data.location || "";
        document.getElementById("eventNotes").value = data.notes || "";
        document.getElementById("deleteBtn").style.display = "block";
        document.getElementById("eventModal").style.display = "block";
      }

      function deleteEvent() {
        if (currentEditingEvent) {
          currentEditingEvent.element.remove();
          updateStats();
          saveToLocalStorage();
          if (currentUser && supabaseClient) {
            saveToSupabase();
          }
        }
        closeModal();
      }

      function checkConflicts(slot, type) {
        const events = slot.querySelectorAll(".event");
        for (let event of events) {
          if (type === "uni" && event.classList.contains("event-work1"))
            return true;
          if (type === "uni" && event.classList.contains("event-work2"))
            return true;
          if (type === "work1" && event.classList.contains("event-uni"))
            return true;
          if (type === "work2" && event.classList.contains("event-uni"))
            return true;
        }
        return false;
      }

      document.getElementById("eventForm").onsubmit = function (e) {
        e.preventDefault();

        const data = {
          type: document.getElementById("eventType").value,
          title: document.getElementById("eventTitle").value,
          location: document.getElementById("eventLocation").value,
          notes: document.getElementById("eventNotes").value,
        };

        if (currentEditingEvent) {
          currentEditingEvent.element.remove();
        }

        const targetSlot = currentEditingEvent
          ? currentEditingEvent.element.parentElement
          : currentSlot;

        if (checkConflicts(targetSlot, data.type)) {
          document.getElementById("conflictWarning").style.display = "block";
          setTimeout(() => {
            document.getElementById("conflictWarning").style.display = "none";
          }, 5000);
        }

        const event = createEvent(data);
        targetSlot.appendChild(event);

        updateStats();
        saveToLocalStorage();
        if (currentUser && supabaseClient) {
          saveToSupabase();
        }
        closeModal();
      };

      function updateWeekDisplay() {
        const endDate = new Date(currentWeekStart);
        endDate.setDate(endDate.getDate() + 6);

        const startStr = `${currentWeekStart.getDate()} ${getMonthName(
          currentWeekStart.getMonth()
        )}`;
        const endStr = `${endDate.getDate()} ${getMonthName(
          endDate.getMonth()
        )} ${endDate.getFullYear()}`;

        document.getElementById(
          "weekDisplay"
        ).textContent = `Settimana del ${startStr} - ${endStr}`;
      }

      function getMonthName(monthIndex) {
        const months = [
          "Gen",
          "Feb",
          "Mar",
          "Apr",
          "Mag",
          "Giu",
          "Lug",
          "Ago",
          "Set",
          "Ott",
          "Nov",
          "Dic",
        ];
        return months[monthIndex];
      }

      function previousWeek() {
        currentWeekStart.setDate(currentWeekStart.getDate() - 7);
        initializeSchedule();
        if (currentUser && supabaseClient) {
          loadFromSupabase();
        }
      }

      function nextWeek() {
        currentWeekStart.setDate(currentWeekStart.getDate() + 7);
        initializeSchedule();
        if (currentUser && supabaseClient) {
          loadFromSupabase();
        }
      }

      function updateStats() {
        let uniHours = 0,
          work1Hours = 0,
          work2Hours = 0,
          conflicts = 0;

        document.querySelectorAll(".slot").forEach((slot) => {
          const events = slot.querySelectorAll(".event");
          let hasUni = false,
            hasWork1 = false,
            hasWork2 = false;

          events.forEach((event) => {
            if (event.classList.contains("event-uni")) {
              uniHours++;
              hasUni = true;
            }
            if (event.classList.contains("event-work1")) {
              work1Hours++;
              hasWork1 = true;
            }
            if (event.classList.contains("event-work2")) {
              work2Hours++;
              hasWork2 = true;
            }
          });

          if ((hasUni && hasWork1) || (hasUni && hasWork2)) {
            conflicts++;
          }
        });

        document.getElementById("uniHours").textContent = uniHours;
        document.getElementById("work1Hours").textContent = work1Hours;
        document.getElementById("work2Hours").textContent = work2Hours;
        document.getElementById("conflicts").textContent = conflicts;
      }

      function saveToLocalStorage() {
        const weekKey = `week_${currentWeekStart.toISOString().split("T")[0]}`;
        const weekData = {};

        document.querySelectorAll(".slot").forEach((slot) => {
          const key = `${slot.dataset.day}_${slot.dataset.time}`;
          const events = [];

          slot.querySelectorAll(".event").forEach((event) => {
            const type = event.classList.contains("event-uni")
              ? "uni"
              : event.classList.contains("event-work1")
              ? "work1"
              : "work2";
            const title = event.querySelector("strong").textContent;
            const locationEl = event.querySelector("small");

            events.push({
              type,
              title,
              location: locationEl ? locationEl.textContent : "",
            });
          });

          if (events.length > 0) {
            weekData[key] = events;
          }
        });

        localStorage.setItem(weekKey, JSON.stringify(weekData));
      }

      function loadEvents() {
        const weekKey = `week_${currentWeekStart.toISOString().split("T")[0]}`;
        const savedData = localStorage.getItem(weekKey);

        if (savedData) {
          const weekData = JSON.parse(savedData);

          Object.entries(weekData).forEach(([key, events]) => {
            const [day, time] = key.split("_");
            const slot = document.querySelector(
              `[data-day="${day}"][data-time="${time}"]`
            );

            if (slot) {
              events.forEach((eventData) => {
                const event = createEvent(eventData);
                slot.appendChild(event);
              });
            }
          });

          updateStats();
        }
      }

      function exportToCSV() {
        let csv = "Data,Giorno,Ora,Tipo,Titolo,Luogo,Note\n";

        days.forEach((day, dayIndex) => {
          timeSlots.forEach((time) => {
            const slot = document.querySelector(
              `[data-day="${dayIndex}"][data-time="${time}"]`
            );
            const events = slot.querySelectorAll(".event");

            events.forEach((event) => {
              const date = new Date(currentWeekStart);
              date.setDate(date.getDate() + dayIndex);
              const dateStr = date.toLocaleDateString("it-IT");

              const type = event.classList.contains("event-uni")
                ? "Universit√†"
                : event.classList.contains("event-work1")
                ? "Lavoro P1"
                : "Lavoro P2";
              const title = event.querySelector("strong").textContent;
              const location = event.querySelector("small")
                ? event.querySelector("small").textContent
                : "";

              csv += `${dateStr},${day},${time},${type},"${title}","${location}",""\n`;
            });
          });
        });

        const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = `orario_settimana_${
          currentWeekStart.toISOString().split("T")[0]
        }.csv`;
        link.click();
      }

      function saveToLocal() {
        saveToLocalStorage();
        alert("Dati salvati localmente! Potrai ricaricarli in futuro.");
      }

      function loadFromLocal() {
        loadEvents();
        alert("Dati caricati con successo!");
      }

      // Initialize on load
      window.onload = function () {
        initializeSchedule();
        initSupabase();
      };

      // Close modal when clicking outside
      window.onclick = function (event) {
        if (event.target == document.getElementById("eventModal")) {
          closeModal();
        }
      };
    </script>
  </body>
</html>
